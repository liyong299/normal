<?xml version="1.0" encoding="UTF-8"?>
<reports>
    <!-- 影院结算金额总月报表  -->
    <report>
        <name>rpt_cinema_settlement_monthly</name>
        <type>monthly</type>
        <schedule_time>02:00:00</schedule_time>
        <table_name>rpt_cinema_settlement_monthly</table_name>
        <del_sql><![CDATA[delete from rpt_cinema_settlement_monthly where settlment_date = [delTimeStr]]]></del_sql>
        <source_sql><![CDATA[insert into rpt_cinema_settlement_monthly(cinemano,cinema_name,cityno,settlemnt_amount,settlment_date)
select 
    consumer_sites_no,
    consumer_sites_name,
    t2.cityno,
    sum(t1.settlement_all_price) settlement_all_price,
    FROM_UNIXTIME(t1.settlementdate,'%Y%m') settlementdate
from
    settl_vouchervalidbase t1
        left join
    base_cinema t2 ON t1.consumer_sites_no = t2.cinemano
where t1.settl_flag=0 and t1.exchange_flag=0
and t1.settlementdate>unix_timestamp([startTimeStr]) and t1.settlementdate<unix_timestamp([endTimeStr])
group by 
consumer_sites_no,
consumer_sites_name,
t2.city;]]></source_sql>
    </report>
    
    <!-- 影院结算产品金额日报表  -->
    <report>
        <name>rpt_cinema_settlement_product_daily</name>
        <type>daily</type>
        <schedule_time>02:00:00</schedule_time>
        <table_name>rpt_cinema_settlement_product_daily</table_name>
        <del_sql><![CDATA[delete from rpt_cinema_settlement_product_daily where settlment_date = [delTimeStr]]]></del_sql>
        <source_sql><![CDATA[insert into rpt_cinema_settlement_product_daily(cinemano,cinema_name,cityno,goodstype,goodsshowtype,settl_orgzaination_id,settlment_amount,settl_price,settl_num,settl_all_num,settlment_date)
select 
    t1.consumer_sites_no,
    t1.consumer_sites_name,
    t2.cityno,
    t1.goodstype,
    t1.goodsshowtype,
    t1.settl_orgzaination_id,
    sum(t1.settlement_all_price) settlement_amount,
    t1.settlementprice,
    sum(t1.goodsnum) goodsnum,
    sum(t1.goodsnum) goodsAllNum,
    FROM_UNIXTIME(t1.settlementdate, '%Y-%m-%d') settlementdate
from
    (select 
        consumer_sites_no,
            consumer_sites_name,
            goodstype,
            goodsshowtype,
            settlement_all_price,
            abs(settlementprice) settlementprice,
            goodsnum,
            settlementdate,
            settl_flag,
            exchange_flag,
            settl_orgzaination_id
    from
        settl_vouchervalidbase
    where
        settl_flag = 0 and exchange_flag = 0) t1
        left join
    base_cinema t2 ON t1.consumer_sites_no = t2.cinemano
where
    t1.settlementdate > unix_timestamp([startTimeStr])
        and t1.settlementdate < unix_timestamp([endTimeStr])
group by t1.consumer_sites_no , t1.consumer_sites_name , t2.cityno , t1.goodstype , t1.goodsshowtype , t1.settl_orgzaination_id , t1.settlementprice
order by settlementdate , goodsshowtype;]]></source_sql>
    </report>
    
    <!-- 第三方预付卡结算月报表   -->
    <report>
        <name>rpt_thirdcard_settlement_monthly</name>
        <type>monthly</type>
        <schedule_time>02:00:00</schedule_time>
        <table_name>rpt_thirdcard_settlement_monthly</table_name>
        <del_sql><![CDATA[delete from rpt_thirdcard_settlement_monthly where settlement_date = [delTimeStr]]]></del_sql>
        <source_sql><![CDATA[insert into rpt_thirdcard_settlement_monthly(card_bin,card_name,settl_orgzaination_id,order_amount,settlement_amount,fee_rate,fee,settlement_date)
select 
    t1.distributorid,
    t1.distributor_name,
    t2.settl_orgzaination_id,
    sum(t1.sale_all_price) order_amount,
    sum(t1.settlement_all_price) settlement_amount,
    t2.fee_rate,
    case t2.fee_type
        when 1 then sum(t1.settlement_all_price) * t2.fee_rate
        when 2 then sum(t1.sale_all_price) * t2.fee_rate
    end fee,
    FROM_UNIXTIME(t1.settlementdate, '%Y-%m-%d') settlementdate
from
    settl_vouchervalidbase t1
        left join
    base_thirdcardinfo t2 ON t1.distributorid = t2.card_bin
where
    t1.settl_flag = 0
        and t1.exchange_flag = 0
		and t1.vouchertype=7
        and t1.settlementdate > unix_timestamp([startTimeStr])
        and t1.settlementdate < unix_timestamp([endTimeStr])
group by t1.distributorid , t1.distributor_name , t2.settl_orgzaination_id , t2.fee_rate;]]></source_sql>
    </report>
    
    <!-- 分销商结算月结表  -->
    <report>
        <name>rpt_distributor_settlement_monthly</name>
        <type>monthly</type>
        <schedule_time>02:00:00</schedule_time>
        <table_name>rpt_distributor_settlement_monthly</table_name>
        <del_sql><![CDATA[delete from rpt_distributor_settlement_monthly where settlement_date = [delTimeStr]]]></del_sql>
        <source_sql><![CDATA[insert into rpt_distributor_settlement_monthly(distributor_id,distributor_name,ticket_num,order_amount,fee_price,fee_rate,fee,settlement_date)
select 
    t1.channle_id,
    t3.channelname,
	sum(t2.quantity),
    sum(t1.final_amount),
	t3.unit_price,
	t3.rate,
	case t3.divided_type when 1 then sum(t2.quantity)*t3.unit_price
	when 2 then sum(t1.final_amount) * t3.rate end fee,
	FROM_UNIXTIME(t1.order_time,'%Y%m') settlementdate
from
    order_orderinfo t1
        left join
    order_orderinfo_detail t2 ON t1.order_no = t2.order_no       
        left join
    base_channel t3 ON t1.channle_id = t3.channelno
where
    (t1.status = 4 or t1.status = 8)
	and t1.order_time>unix_timestamp([startTimeStr]) and t1.order_time<unix_timestamp([endTimeStr])
group by t1.channle_id , t3.channelname , t1.channle_id ,t1.order_type;]]></source_sql>
    </report>
    
    <!-- 分销商收款统计表  -->
    <report>
        <name>rpt_distributor_cash_monthly</name>
        <type>monthly</type>
        <schedule_time>02:00:00</schedule_time>
        <table_name>rpt_distributor_cash_monthly</table_name>
        <del_sql><![CDATA[delete from rpt_distributor_cash_monthly where settlment_date = [delTimeStr]]]></del_sql>
        <source_sql><![CDATA[insert into rpt_distributor_cash_monthly(distributor_id,distributor_name,client_id,paychannle_id,order_type,ticket_num,sale_amount,settlment_date) 
select 
    t1.channle_id,
    t3.channelname,
    t1.channle_id,
    t4.pay_chanenl_id,
    t1.order_type,
	sum(t2.quantity),
    sum(t4.amount),
    FROM_UNIXTIME(t1.order_time,'%Y%m') settlementdate  
from
    order_orderinfo t1
        left join
    order_orderinfo_detail t2 ON t1.order_no = t2.order_no
        left join
    order_order_pay_detail t4 ON t4.order_no = t2.order_no
        left join
    base_channel t3 ON t1.channle_id = t3.channelno
where
    (t1.status = 4 or t1.status = 8)
	and t1.order_time>unix_timestamp([startTimeStr]) and t1.order_time<unix_timestamp([endTimeStr])
group by t1.channle_id , t3.channelname , t1.channle_id , t4.pay_chanenl_id , t1.order_type;]]></source_sql>
    </report>
    
    <!-- 线上业务收款渠道统计表  -->
    <report>
        <name>rpt_paychannel_cash_monthly</name>
        <type>monthly</type>
        <schedule_time>02:00:00</schedule_time>
        <table_name>rpt_paychannel_cash_monthly</table_name>
        <del_sql><![CDATA[delete from rpt_paychannel_cash_monthly where settlement_date = [delTimeStr]]]></del_sql>
        <source_sql><![CDATA[insert into rpt_paychannel_cash_monthly(paychannle_id,sale_amount,settlement_date)
select 
    t1.pay_chanenl_id,
	sum(t1.amount) sale_amount,
	FROM_UNIXTIME(t1.pay_time,'%Y%m') settlementdate
from
    order_order_pay_detail t1
        left join
    base_paychannel t2 ON t1.pay_chanenl_id = t2.pay_channel_id
where t1.pay_time>unix_timestamp([startTimeStr]) and t1.pay_time<unix_timestamp([endTimeStr])
group by t1.pay_chanenl_id;]]></source_sql>
    </report>
    
      <!-- 微影选座票报表（中影订单状态:4.凭证成功、6地面出票失败、7凭证失败,8:已撤销）  -->
    <report>
        <name>rpt_wycinema_daily</name>
        <type>daily</type>
        <schedule_time>01:30:00</schedule_time>
        <table_name>rpt_wycinema_daily</table_name>
        <del_sql><![CDATA[delete from rpt_wycinema_daily where date_format(ordertime,'%Y-%m-%d') = [delTimeStr]]]></del_sql>
        <source_sql><![CDATA[INSERT into rpt_wycinema_daily (orderno,wyorderno,ordertime,status,amount,cinemano,cinemaname) 
												      select o.order_no as orderno,r.ordercode as wyorderno, FROM_UNIXTIME(order_time) as ordertime,o.`status`,
														o.amount,r.cinemacode  as cinemano,c.cinemaname as cinemaname 
														from order_orderinfo o,
														acc_orderrequest r,base_cinema c 
														where o.`status`>=3 and o.order_no = r.channelordercode and r.currentfun='submitOrder'
														and r.normcinemacode =c.cinemano 
														and order_time >= unix_timestamp([startTimeStr])
														and order_time <= unix_timestamp([endTimeStr])
]]></source_sql>
    </report>
</reports>